name: CI/CD - Build and Deploy JAR

on:
  push:
    branches:
      - master  # Listen for pushes to master branch111

jobs:
  build:
    name: Build JAR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: pet-tracker-review-app
          path: target/*.jar

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: pet-tracker-review-app
          path: target/

      - name: Verify JAR file
        run: |
          JAR_COUNT=$(find target/ -name "*.jar" -type f | wc -l)
          if [ "$JAR_COUNT" -gt 0 ]; then
            echo "JAR file(s) found, proceeding with deployment."
            find target/ -name "*.jar" -type f -exec ls -la {} \;
          else
            echo "JAR file not found! Download might have failed."
            ls -la target/ || echo "Target directory not found"
            exit 1
          fi

      - name: Remove old JAR file on remote server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 60s
          command_timeout: 120s
          script: |
            set +e  # Don't exit on errors
            echo "ðŸ” Starting cleanup process..."
            
            # Check current directory
            echo "ðŸ“ Current directory: $(pwd)"
            
            # Create directory if not exists
            echo "ðŸ“‚ Creating project directory..."
            sudo mkdir -p /home/project/affiliate
            sudo chown ${{ secrets.EC2_USERNAME }}:${{ secrets.EC2_USERNAME }} /home/project/affiliate
            
            # Change to project directory
            cd /home/project/affiliate
            echo "ðŸ“ Working directory: $(pwd)"
            
            # Stop existing application gracefully
            echo "ðŸ›‘ Stopping existing application..."
            if pgrep -f "pet-tracker-review" > /dev/null; then
              echo "Found running application, stopping it..."
              
              # Get PIDs before killing
              PIDS=$(pgrep -f "pet-tracker-review")
              echo "Found PIDs: $PIDS"
              
              # Kill processes gracefully
              pkill -TERM -f "pet-tracker-review" || echo "No processes to terminate"
              sleep 5
              
              # Check if any processes are still running
              if pgrep -f "pet-tracker-review" > /dev/null; then
                echo "Some processes still running, force killing..."
                pkill -9 -f "pet-tracker-review" || echo "No processes to force kill"
                sleep 2
              fi
              
              echo "âœ… Application stopped successfully"
            else
              echo "â„¹ï¸ No existing application found"
            fi
            
            # Remove old JAR files
            echo "ðŸ—‘ï¸ Removing old JAR files..."
            rm -f *.jar || true
            rm -rf target || true
            echo "âœ… Old JAR files removed"
            
            echo "âœ… Cleanup completed"

      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar"
          target: "/home/project/affiliate"
          timeout: 120s

      - name: Restart Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 60s
          command_timeout: 120s
          script: |
            set +e  # Don't exit on errors
            
            cd /home/project/affiliate
            echo "ðŸ“ Current directory: $(pwd)"
            
            # Verify JAR file was uploaded
            echo "ðŸ” Checking uploaded files..."
            ls -la
            ls -la target/ || echo "Target directory not found"
            
            # Find and rename the uploaded JAR file
            JAR_FILE=$(find target/ -name "*.jar" -type f | head -n 1)
            if [ -n "$JAR_FILE" ] && [ -f "$JAR_FILE" ]; then
              echo "âœ… JAR file found: $JAR_FILE"
              
              # Copy JAR to standard name for easier management
              echo "ðŸ“¦ Setting up JAR file..."
              cp "$JAR_FILE" ./pet-tracker-review.jar
              chmod 644 pet-tracker-review.jar
              echo "âœ… JAR file ready: pet-tracker-review.jar"
              
            else
              echo "âŒ No JAR file found in target directory!"
              echo "Files in target directory:"
              ls -la target/ || echo "Target directory not found"
              exit 1
            fi
            
            # Check Java installation
            echo "â˜• Checking Java installation..."
            java -version || {
              echo "âŒ Java not found!"
              exit 1
            }
            
            # Start application
            echo "ðŸš€ Starting Pet Tracker Review application..."
            
            # Clean up old log file
            rm -f app.log || true
            
            # Start application in background
            nohup java -jar pet-tracker-review.jar \
              --spring.profiles.active=prod \
              --server.port=8089 \
              > app.log 2>&1 &
            
            # Get the PID
            APP_PID=$!
            echo "Application started with PID: $APP_PID"
            
            # Save PID for future reference
            echo $APP_PID > app.pid
            
            # Wait for startup
            echo "â³ Waiting for application to start..."
            sleep 15
            
            # Check if application is still running
            if ps -p "$APP_PID" > /dev/null 2>&1; then
              echo "âœ… Application is running with PID: $APP_PID"
              
              # Check if port is listening (with retry)
              for i in {1..6}; do
                if netstat -tuln | grep :8089 > /dev/null 2>&1; then
                  echo "âœ… Port 8089 is listening"
                  echo "ðŸŒ Application is accessible on port 8089"
                  echo "ðŸš€ Deployment completed successfully!"
                  exit 0
                else
                  echo "â³ Waiting for port 8089... (attempt $i/6)"
                  sleep 5
                fi
              done
              
              echo "âš ï¸ Port 8089 not listening, but process is running"
              echo "ðŸ“„ Recent log output:"
              tail -20 app.log 2>/dev/null || echo "No log file found"
              echo "ðŸš€ Deployment completed (process running, check logs for port status)"
              
            else
              echo "âŒ Application failed to start or crashed"
              echo "ðŸ“„ Recent log output:"
              tail -20 app.log 2>/dev/null || echo "No log file found"
              exit 1
            fi