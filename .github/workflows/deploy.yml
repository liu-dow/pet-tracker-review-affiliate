name: Deploy to AWS  EC2ã€€ã€€

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'adopt'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build with Maven
      run: mvn clean package -DskipTests -Pprod
    
    - name: Verify JAR file
      run: |
        ls -la target/
        echo "JAR file size:"
        du -h target/*.jar
    
    - name: Upload JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "target/*.jar"
        target: "/home/project/affiliate/"
        strip_components: 1
        overwrite: true
    
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/project/affiliate
          
          # Create necessary directories if they don't exist
          mkdir -p logs uploads/images uploads/metadata
          
          # Stop existing application gracefully
          if pgrep -f "pet-tracker-review" > /dev/null; then
            echo "Stopping existing application..."
            pkill -TERM -f "pet-tracker-review"
            
            # Wait for graceful shutdown
            sleep 10
            
            # Force kill if still running
            if pgrep -f "pet-tracker-review" > /dev/null; then
              echo "Force stopping application..."
              pkill -KILL -f "pet-tracker-review"
            fi
          fi
          
          # Backup old JAR if exists
          if [ -f pet-tracker-review.jar ]; then
            mv pet-tracker-review.jar pet-tracker-review-backup-$(date +%Y%m%d_%H%M%S).jar
            echo "âœ… Old JAR backed up"
          fi
          
          # Move new JAR to working name
          if [ -f pet-tracker-review-*.jar ]; then
            mv pet-tracker-review-*.jar pet-tracker-review.jar
            echo "âœ… New JAR file prepared"
          else
            echo "âŒ No JAR file found!"
            exit 1
          fi
          
          # Verify JAR file integrity
          if ! java -jar pet-tracker-review.jar --help > /dev/null 2>&1; then
            echo "âš ï¸  JAR file verification skipped (--help not supported)"
          fi
          
          # Check Java version
          echo "Java version:"
          java -version
          
          # Start new application with proper configuration
          echo "Starting new application on port 8089..."
          nohup java -jar pet-tracker-review.jar \
            --spring.profiles.active=prod \
            --server.port=8089 \
            --logging.file.name=logs/application.log \
            > logs/app.log 2>&1 &
          
          # Get process ID
          sleep 3
          PID=$(pgrep -f "pet-tracker-review")
          
          if [ -n "$PID" ]; then
            echo "âœ… Application started successfully with PID: $PID"
            echo $PID > pet-tracker-review.pid
          else
            echo "âŒ Application failed to start"
            echo "Last 20 lines of log:"
            tail -20 logs/app.log 2>/dev/null || echo "No log file found"
            exit 1
          fi
          
          # Wait for application to fully start
          echo "Waiting for application to start..."
          sleep 10
          
          # Test application endpoint
          if curl -f http://localhost:8089/actuator/health > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          elif curl -f http://localhost:8089/ > /dev/null 2>&1; then
            echo "âœ… Application responding on port 8089"
          else
            echo "âš ï¸  Health check failed, but process is running"
            echo "Application logs:"
            tail -10 logs/app.log 2>/dev/null || echo "No recent logs"
          fi
          
          # Clean up old backup files (keep only last 3)
          ls -t pet-tracker-review-backup-*.jar 2>/dev/null | tail -n +4 | xargs -r rm
          
          echo "ðŸš€ Deployment completed successfully!"
          echo "Application should be accessible on port 8089"